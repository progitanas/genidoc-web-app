<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tableau de Bord Admin - GeniDoc</title>
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4d3aff" />
    <style>
      :root {
        --primary: #4d3aff;
        --secondary: #00558c;
        --light-bg: #f5f7fa;
        --dark-text: #2d3748;
        --border-radius: 8px;
        --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--light-bg);
        color: var(--dark-text);
      }

      .header {
        background: white;
        padding: 20px;
        box-shadow: var(--box-shadow);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: var(--secondary);
        font-size: 24px;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
      }

      .logout-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
      }

      .logout-btn:hover {
        background: #c0392b;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px 40px;
      }

      .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 30px;
        border-bottom: 2px solid #e0e0e0;
        overflow-x: auto;
      }

      .tab-btn {
        padding: 12px 20px;
        border: none;
        background: transparent;
        color: #999;
        cursor: pointer;
        font-weight: 600;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
        transition: var(--transition);
        white-space: nowrap;
      }

      .tab-btn:hover {
        color: var(--secondary);
      }

      .tab-btn.active {
        color: var(--secondary);
        border-bottom-color: var(--primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        margin-bottom: 20px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        text-align: center;
      }

      .stat-card h3 {
        color: #999;
        font-size: 13px;
        margin-bottom: 10px;
      }

      .stat-card .value {
        color: var(--primary);
        font-size: 32px;
        font-weight: 700;
      }

      .card h2 {
        color: var(--secondary);
        margin-bottom: 20px;
        font-size: 18px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      thead {
        background: var(--light-bg);
      }

      th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: var(--secondary);
        border-bottom: 2px solid #e0e0e0;
      }

      td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
      }

      .btn {
        padding: 10px 15px;
        border: none;
        border-radius: var(--border-radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        font-size: 13px;
      }

      .btn-primary {
        background: var(--primary);
        color: white;
      }

      .btn-primary:hover {
        background: #3c2acc;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(77, 58, 255, 0.3);
      }

      .btn-secondary {
        background: var(--secondary);
        color: white;
      }

      .btn-secondary:hover {
        background: #003d66;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      @media (min-width: 720px) {
        .form-row {
          grid-template-columns: 1fr 1fr;
        }
      }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 6px;
        font-size: 13px;
        color: var(--dark-text);
        margin-top: 12px;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: var(--border-radius);
        font-size: 14px;
        font-family: inherit;
        margin-top: 4px;
        transition: var(--transition);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(77, 58, 255, 0.1);
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 40px;
        border-radius: var(--border-radius);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-content h3 {
        color: var(--secondary);
        margin-bottom: 20px;
        font-size: 18px;
      }

      .close-modal {
        float: right;
        cursor: pointer;
        font-size: 24px;
        color: #999;
      }

      .close-modal:hover {
        color: var(--secondary);
      }

      .success-message {
        background: #f0f8f4;
        color: #27ae60;
        padding: 12px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        display: none;
      }

      .success-message.show {
        display: block;
      }

      .error-message {
        background: #fde8e6;
        color: #e74c3c;
        padding: 12px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .doctor-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }

      .doctor-card {
        background: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
      }

      .doctor-card h3 {
        color: var(--secondary);
        margin-bottom: 10px;
      }

      .doctor-card p {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px;
      }

      .doctor-card-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .doctor-card-actions button {
        flex: 1;
        padding: 8px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <script>
      // Session/authentication check for admin-dashboard.html
      (function () {
        var adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
          window.location.href = 'auth.html';
        }
      })();
    </script>
    <div class="header">
      <h1>üìä Tableau de Bord Admin</h1>
      <div class="user-info">
        <div class="user-avatar" id="avatar-init">A</div>
        <span id="user-name">Admin</span>
        <button
          id="install-app-btn"
          class="btn btn-primary"
          style="margin-right: 8px; display: none"
        >
          Installer
        </button>
        <button class="logout-btn" onclick="logout()">D√©connexion</button>
      </div>
    </div>

    <div class="container">
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(0)">
          Statistiques
        </button>
        <button class="tab-btn" onclick="switchTab(1)">M√©decins</button>
        <button class="tab-btn" onclick="switchTab(2)">Rendez-vous</button>
        <button class="tab-btn" onclick="switchTab(4)">
          Demandes sociales
        </button>
        <button class="tab-btn" onclick="switchTab(5)">Support</button>
        <button
          class="tab-btn"
          title="Param√®tres"
          onclick="window.location.href='settings.html'"
          style="display: flex; align-items: center; gap: 6px"
        >
          <img
            src="images-keyfeatures/parametres.png"
            alt="Param√®tres"
            style="
              width: 22px;
              height: 22px;
              vertical-align: middle;
              margin-right: 4px;
            "
          />
          <span style="vertical-align: middle">Param√®tres</span>
        </button>
      </div>

      <!-- STATISTICS TAB -->
      <div id="tab-0" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>M√©decins</h3>
            <div class="value" id="doctor-count">0</div>
          </div>
          <div class="stat-card">
            <h3>Patients</h3>
            <div class="value" id="patient-count">0</div>
          </div>
          <div class="stat-card">
            <h3>Rendez-vous</h3>
            <div class="value" id="appointment-count">0</div>
          </div>
          <div class="stat-card">
            <h3>Revenus (DZD)</h3>
            <div class="value" id="revenue">0</div>
          </div>
        </div>

        <div class="card">
          <h2>Rendez-vous R√©cents</h2>
          <table>
            <thead>
              <tr>
                <th>Patient</th>
                <th>M√©decin</th>
                <th>Date</th>
                <th>Statut</th>
                <th>Lieu</th>
              </tr>
            </thead>
            <tbody id="recent-appointments">
              <tr>
                <td colspan="4" style="text-align: center; color: #999">
                  Chargement...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- DOCTORS TAB -->
      <div id="tab-1" class="tab-content">
        <button
          class="btn btn-primary"
          onclick="openAddDoctorModal()"
          style="margin-bottom: 20px"
        >
          ‚ûï Ajouter M√©decin
        </button>

        <div class="doctor-grid" id="doctor-list">
          <div
            style="
              grid-column: 1/-1;
              text-align: center;
              color: #999;
              padding: 40px;
            "
          >
            Chargement...
          </div>
        </div>
      </div>

      <!-- APPOINTMENTS TAB -->
      <div id="tab-2" class="tab-content">
        <div class="card">
          <h2>Tous les Rendez-vous</h2>
          <div
            style="
              margin-bottom: 16px;
              display: flex;
              gap: 16px;
              align-items: center;
            "
          >
            <label for="filter-specialty">Filtrer par sp√©cialit√© :</label>
            <select id="filter-specialty" onchange="loadDashboard()">
              <option value="">Toutes</option>
              <option value="Cardiologie">Cardiologie</option>
              <option value="Dermatologie">Dermatologie</option>
              <option value="Neurologie">Neurologie</option>
              <option value="P√©diatrie">P√©diatrie</option>
              <option value="Orthop√©die">Orthop√©die</option>
              <option value="Gyn√©cologie">Gyn√©cologie</option>
            </select>
            <label for="filter-date" style="margin-left: 16px">Date :</label>
            <input
              type="date"
              id="filter-date"
              onchange="loadDashboard()"
              style="padding: 4px 8px"
            />
            <input
              id="search-appointment"
              type="text"
              placeholder="Recherche patient ou m√©decin..."
              style="margin-left: 16px; padding: 4px 8px; width: 200px"
              oninput="loadDashboard()"
            />
            <button
              id="filter-unassigned"
              type="button"
              style="margin-left: 16px; padding: 4px 12px"
              onclick="toggleUnassigned()"
            >
              Afficher uniquement les non attribu√©s
            </button>
            <button
              id="export-csv"
              type="button"
              style="margin-left: 16px; padding: 4px 12px"
              onclick="exportAppointmentsCSV()"
            >
              Exporter CSV
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Patient</th>
                <th>M√©decin</th>
                <th>Date/Heure</th>
                <th>Type</th>
                <th>Statut</th>
                <th>Actions</th>
                <th>RDV/jour</th>
              </tr>
            </thead>
            <tbody id="appointment-list">
              <tr>
                <td colspan="6" style="text-align: center; color: #999">
                  Chargement...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SOCIAL REQUESTS TAB -->
      <div id="tab-4" class="tab-content">
        <div class="card">
          <h2>Demandes de couverture sociale</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Nom</th>
                <th>UniqueID</th>
                <th>Type</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="social-requests-list">
              <tr>
                <td colspan="6" style="text-align: center; color: #999">
                  Chargement...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SUPPORT TAB -->
      <div id="tab-5" class="tab-content">
        <div class="card">
          <h2>Tickets Support</h2>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Utilisateur</th>
                <th>Sujet</th>
                <th>Message</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="support-list">
              <tr>
                <td colspan="6" style="text-align: center; color: #999">
                  Chargement...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="tab-3" class="tab-content">
        <div class="card">
          <h2>Param√®tres √âtablissement</h2>
          <form onsubmit="saveSettings(event)">
            <label>Nom de l'√©tablissement</label>
            <input
              type="text"
              id="establishment-name"
              placeholder="Ex: Clinique Saint-Jean"
            />

            <label>T√©l√©phone</label>
            <input
              type="tel"
              id="establishment-phone"
              placeholder="Ex: +213 21 123 4567"
            />

            <label>Adresse</label>
            <input
              type="text"
              id="establishment-address"
              placeholder="Ex: 123 Rue de la Paix, Alger"
            />

            <label>Email</label>
            <input
              type="email"
              id="establishment-email"
              placeholder="Ex: contact@clinique.dz"
            />

            <label>Horaires d'ouverture</label>
            <input
              type="text"
              id="establishment-hours"
              placeholder="Ex: 08:00 - 18:00"
            />

            <label>Devise</label>
            <select id="establishment-currency">
              <option value="DZD">Dinar Alg√©rien (DZD)</option>
              <option value="USD">Dollar Am√©ricain (USD)</option>
              <option value="EUR">Euro (EUR)</option>
            </select>

            <button class="btn btn-primary" style="margin-top: 20px">
              Enregistrer
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Add Doctor Modal -->
    <div id="add-doctor-modal" class="modal">
      <div class="modal-content">
        <span class="close-modal" onclick="closeModal('add-doctor-modal')"
          >&times;</span
        >
        <h3>Ajouter un M√©decin</h3>
        <div class="success-message" id="doctor-success"></div>
        <form onsubmit="addDoctor(event)">
          <div class="form-row">
            <div>
              <label>Pr√©nom</label>
              <input type="text" id="doctor-first-name" required />
            </div>
            <div>
              <label>Nom</label>
              <input type="text" id="doctor-last-name" required />
            </div>
          </div>
          <label>Email</label>
          <input type="email" id="doctor-email" required />

          <label>License</label>
          <input type="text" id="doctor-license" required />

          <label>Sp√©cialit√©</label>
          <select id="doctor-specialty" required>
            <option value="">-- S√©lectionner --</option>
            <option value="Cardiologie">Cardiologie</option>
            <option value="Dermatologie">Dermatologie</option>
            <option value="Neurologie">Neurologie</option>
            <option value="P√©diatrie">P√©diatrie</option>
            <option value="Orthop√©die">Orthop√©die</option>
            <option value="Gyn√©cologie">Gyn√©cologie</option>
          </select>

          <label>T√©l√©phone</label>
          <input type="tel" id="doctor-phone" required />

          <button class="btn btn-primary" style="width: 100%; margin-top: 20px">
            Ajouter
          </button>
        </form>
      </div>
    </div>

    <script>
      const API = 'http://localhost:3000/api';

      function switchTab(index) {
        document
          .querySelectorAll('.tab-content')
          .forEach((el) => el.classList.remove('active'));
        document
          .querySelectorAll('.tab-btn')
          .forEach((el) => el.classList.remove('active'));

        const contents = document.querySelectorAll('.tab-content');
        const buttons = document.querySelectorAll('.tab-btn');

        if (contents[index]) contents[index].classList.add('active');
        if (buttons[index]) buttons[index].classList.add('active');
      }

      function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
      }

      function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
      }

      function openAddDoctorModal() {
        openModal('add-doctor-modal');
      }

      // ========== S√âCURIT√â SESSION ========== //
      function forceLogout(msg) {
        localStorage.clear();
        // Session expired logic removed as requested
        window.location.href = '/auth.html';
      }

      async function secureFetch(url, options = {}, errorMsg) {
        const res = await fetch(url, options);
        if (res.status === 401 || res.status === 403) {
          forceLogout();
          throw new Error('D√©connect√©');
        }
        return res;
      }

      function logout() {
        forceLogout();
      }

      async function addDoctor(e) {
        e.preventDefault();
        const firstName = document.getElementById('doctor-first-name').value;
        const lastName = document.getElementById('doctor-last-name').value;
        const email = document.getElementById('doctor-email').value;
        const license = document.getElementById('doctor-license').value;
        const specialty = document.getElementById('doctor-specialty').value;
        const phone = document.getElementById('doctor-phone').value;
        try {
          const response = await secureFetch(
            `${API}/doctors`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${localStorage.getItem('token')}`,
              },
              body: JSON.stringify({
                firstName,
                lastName,
                email,
                licenseNumber: license,
                specialization: specialty,
                phone,
              }),
            },
            "Acc√®s interdit ou session expir√©e lors de l'ajout de m√©decin."
          );
          const data = await response.json();
          if (data.success) {
            document.getElementById('doctor-success').textContent =
              'M√©decin ajout√© avec succ√®s!';
            document.getElementById('doctor-success').classList.add('show');
            setTimeout(() => {
              closeModal('add-doctor-modal');
              location.reload();
            }, 1500);
          }
        } catch (error) {
          if (error.message !== 'D√©connect√©') {
            console.error('Error:', error);
          }
        }
      }

      async function loadDashboard() {
        try {
          const token = localStorage.getItem('token');
          const user = JSON.parse(localStorage.getItem('user') || '{}');
          if (!token) {
            forceLogout();
            return;
          }
          document.getElementById('user-name').textContent =
            user.firstName || 'Admin';
          document.getElementById('avatar-init').textContent =
            (user.firstName || 'A')[0].toUpperCase();

          // Load stats
          try {
            const statsResponse = await secureFetch(`${API}/admin/stats`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            const stats = await statsResponse.json();
            if (stats.success) {
              document.getElementById('doctor-count').textContent =
                stats.data.doctorCount || 0;
              document.getElementById('patient-count').textContent =
                stats.data.patientCount || 0;
              document.getElementById('appointment-count').textContent =
                stats.data.appointmentCount || 0;
              document.getElementById('revenue').textContent = (
                stats.data.revenue || 0
              ).toFixed(0);
            }
          } catch (e) {
            console.warn('Could not load stats', e);
          }

          // Load doctors first (needed for selects)
          let doctors = [];
          try {
            const doctorsResponse = await secureFetch(`${API}/doctors`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            const doctorsData = await doctorsResponse.json();
            if (doctorsData.success && Array.isArray(doctorsData.data)) {
              doctors = doctorsData.data;
              const doctorList = document.getElementById('doctor-list');
              if (doctors.length) {
                doctorList.innerHTML = doctors
                  .map(
                    (doctor) => `
                        <div class="doctor-card">
                            <h3>${doctor.firstName} ${doctor.lastName}</h3>
                            <p><strong>${
                              doctor.specialization || '-'
                            }</strong></p>
                            <p>üìß ${doctor.email || '-'}</p>
                            <p>üìû ${doctor.phone || '-'}</p>
                            <div class="doctor-card-actions">
                                <button class="btn btn-secondary" onclick="editDoctor('${
                                  doctor.id
                                }')">Modifier</button>
                                <button class="btn btn-danger" onclick="deleteDoctor('${
                                  doctor.id
                                }')">Supprimer</button>
                            </div>
                        </div>
                    `
                  )
                  .join('');
              } else {
                doctorList.innerHTML =
                  '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px">Aucun m√©decin</div>';
              }
            }
          } catch (e) {
            console.warn('Could not load doctors', e);
          }

          // Load appointments
          let appointments = [];
          try {
            const appointmentsResponse = await secureFetch(
              `${API}/admin/appointments`,
              { headers: { Authorization: `Bearer ${token}` } }
            );
            const appointmentsData = await appointmentsResponse.json();
            if (
              appointmentsData.success &&
              Array.isArray(appointmentsData.data)
            ) {
              appointments = appointmentsData.data;
            }
          } catch (e) {
            console.warn('Could not load appointments', e);
          }

          // Recent appointments
          const recentTbody = document.getElementById('recent-appointments');
          if (appointments.length) {
            recentTbody.innerHTML = appointments
              .slice(0, 5)
              .map((apt) => {
                const doctorCell =
                  apt.doctorName ||
                  (apt.doctorId ? apt.doctorId : '<em>Non attribu√©</em>');
                return `
                <tr>
                  <td>${apt.patientName || 'N/A'}</td>
                  <td>${doctorCell}</td>
                  <td>${
                    apt.date
                      ? new Date(apt.date).toLocaleDateString('fr-FR')
                      : '-'
                  }</td>
                  <td><span style="color: var(--primary);">${
                    apt.status || 'Pending'
                  }</span></td>
                  <td>${apt.establishment_name || 'Non sp√©cifi√©'}</td>
                </tr>
              `;
              })
              .join('');
          } else {
            recentTbody.innerHTML =
              '<tr><td colspan="5" style="text-align:center;color:#999">Aucun rendez-vous r√©cent</td></tr>';
          }

          // Full appointment list rendering (simple)
          const appointmentList = document.getElementById('appointment-list');
          appointmentList.innerHTML = '';
          window._lastFilteredAppointments = appointments;
          if (appointments.length) {
            appointments.forEach((appt) => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${appt.fullName || appt.patientName || '-'}</td>
                <td>${appt.doctorName || '-'}</td>
                <td>${appt.date || '-'} ${appt.time || ''}</td>
                <td>${appt.service || '-'}</td>
                <td>${appt.status || '-'}</td>
                <td></td>
                <td class="rdv-count-cell">-</td>
              `;
              // if unassigned, add select
              if (!appt.doctorId && doctors.length) {
                const select = document.createElement('select');
                select.innerHTML =
                  `<option value="">Attribuer √†...</option>` +
                  doctors
                    .map(
                      (d) =>
                        `<option value="${d.id}">${d.firstName} ${
                          d.lastName
                        } (${d.specialization || '-'})</option>`
                    )
                    .join('');
                select.onchange = async function () {
                  if (!this.value) return;
                  try {
                    const res = await secureFetch(
                      `${API}/appointments/${appt.id}/assign`,
                      {
                        method: 'POST',
                        headers: {
                          'Content-Type': 'application/json',
                          Authorization: `Bearer ${token}`,
                        },
                        body: JSON.stringify({ doctorId: this.value }),
                      }
                    );
                    const result = await res.json();
                    if (result.success) {
                      alert('Rendez-vous attribu√© !');
                      loadDashboard();
                    } else {
                      alert(result.message || "Erreur lors de l'attribution");
                    }
                  } catch (e) {
                    console.error(e);
                  }
                };
                tr.querySelector('td:nth-child(6)').innerHTML = '';
                tr.querySelector('td:nth-child(6)').appendChild(select);
              }
              appointmentList.appendChild(tr);
            });
          } else {
            appointmentList.innerHTML =
              '<tr><td colspan="7" style="text-align:center;color:#999">Aucun rendez-vous</td></tr>';
          }

          // Load social requests
          try {
            const sr = await secureFetch(`${API}/social-requests`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            const srj = await sr.json();
            const el = document.getElementById('social-requests-list');
            if (srj.success && Array.isArray(srj.data) && srj.data.length) {
              el.innerHTML = srj.data
                .map(
                  (r) => `
                <tr>
                  <td>${r.id}</td>
                  <td>${r.fullname}</td>
                  <td>${r.uniqueid}</td>
                  <td>${r.coverageType || '-'}</td>
                  <td>${r.status || '-'}</td>
                  <td>
                    <button class="btn btn-primary" onclick="adminUpdateSupport('${
                      r.id
                    }','in_progress')">En cours</button>
                    <button class="btn btn-secondary" onclick="adminUpdateSupport('${
                      r.id
                    }','closed')">Cl√¥turer</button>
                  </td>
                </tr>
              `
                )
                .join('');
            } else {
              el.innerHTML =
                '<tr><td colspan="6" style="text-align:center;color:#999">Aucune demande</td></tr>';
            }
          } catch (e) {
            console.warn('Could not load social requests:', e);
          }

          // Load support tickets
          try {
            const sp = await secureFetch(`${API}/support`, {
              headers: { Authorization: `Bearer ${token}` },
            });
            const spj = await sp.json();
            const elSupport = document.getElementById('support-list');
            if (spj.success && Array.isArray(spj.data) && spj.data.length) {
              elSupport.innerHTML = spj.data
                .map(
                  (s) => `
                <tr>
                  <td>${s.id}</td>
                  <td>${s.userName || s.user || '-'}</td>
                  <td>${s.subject || '-'}</td>
                  <td>${s.message || '-'}</td>
                  <td>${s.status || '-'}</td>
                  <td>
                    <button class="btn btn-primary" onclick="adminUpdateSupport('${
                      s.id
                    }','in_progress')">En cours</button>
                    <button class="btn btn-secondary" onclick="adminUpdateSupport('${
                      s.id
                    }','closed')">Cl√¥turer</button>
                  </td>
                </tr>
              `
                )
                .join('');
            } else {
              elSupport.innerHTML =
                '<tr><td colspan="6" style="text-align:center;color:#999">Aucun ticket</td></tr>';
            }
          } catch (e) {
            console.warn('Could not load support tickets:', e);
          }
        } catch (e) {
          console.error('loadDashboard error', e);
        }
      }

      // Utility: export filtered appointments to CSV
      let showUnassignedOnly = false;
      function exportAppointmentsCSV() {
        const arr = window._lastFilteredAppointments || [];
        let csv = 'Patient,Medecin,Date/Heure,Type,Statut\n';
        arr.forEach((appt) => {
          const row = [
            '"' +
              (appt.fullName || appt.patientName || '').replace(/"/g, '""') +
              '"',
            '"' + (appt.doctorName || '-') + '"',
            '"' +
              ((appt.date || '-') + ' ' + (appt.time || '')).replace(
                /"/g,
                '""'
              ) +
              '"',
            '"' + (appt.service || '-') + '"',
            '"' + (appt.status || '-') + '"',
          ];
          csv += row.join(',') + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'rendezvous.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function toggleUnassigned() {
        showUnassignedOnly = !showUnassignedOnly;
        const btn = document.getElementById('filter-unassigned');
        if (btn)
          btn.textContent = showUnassignedOnly
            ? 'Afficher tous les rendez-vous'
            : 'Afficher uniquement les non attribu√©s';
        loadDashboard();
      }

      // Admin actions for social requests
      async function adminUpdateSocial(id, status) {
        if (!confirm('Confirmer la mise √† jour du statut ?')) return;
        try {
          const token = localStorage.getItem('token');
          const res = await secureFetch(`${API}/social-requests/${id}/status`, {
            method: 'PUT',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status }),
          });
          const j = await res.json();
          if (j.success) {
            alert('Statut mis √† jour');
            loadDashboard();
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function adminUpdateSupport(id, status) {
        if (!confirm('Confirmer la mise √† jour du ticket ?')) return;
        try {
          const token = localStorage.getItem('token');
          const res = await secureFetch(`${API}/support/${id}/status`, {
            method: 'PUT',
            headers: {
              Authorization: `Bearer ${token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status }),
          });
          const j = await res.json();
          if (j.success) {
            alert('Ticket mis √† jour');
            loadDashboard();
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function saveSettings(e) {
        e.preventDefault();
        alert('Param√®tres sauvegard√©s (fonction √† impl√©menter)');
      }

      // Load dashboard on page load
      document.addEventListener('DOMContentLoaded', loadDashboard);
      // PWA: improved install flow + redirect to genidoc.ma
      (function () {
        let deferredPrompt = null;
        const installBtn = document.getElementById('install-app-btn');

        function openGenidoc() {
          try {
            window.location.href = 'https://genidoc.ma';
          } catch (e) {
            window.open('https://genidoc.ma', '_blank');
          }
        }

        window.addEventListener('beforeinstallprompt', (e) => {
          e.preventDefault();
          deferredPrompt = e;
          if (installBtn) installBtn.style.display = 'inline-block';
        });

        if (installBtn) {
          installBtn.style.display = 'inline-block';
          installBtn.addEventListener('click', async (ev) => {
            ev.preventDefault();
            installBtn.disabled = true;
            if (deferredPrompt) {
              try {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
              } catch (err) {
                console.warn(err);
              }
              installBtn.disabled = false;
              openGenidoc();
              return;
            }
            if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
              alert(
                "Pour ajouter GeniDoc √† l'√©cran d'accueil : appuyez sur le bouton 'Partager' puis 'Ajouter √† l'√©cran d'accueil'. Vous serez ensuite redirig√© vers genidoc.ma."
              );
              openGenidoc();
              installBtn.disabled = false;
              return;
            }
            openGenidoc();
            installBtn.disabled = false;
          });
        }

        if ('serviceWorker' in navigator) {
          navigator.serviceWorker
            .register('/service-worker.js')
            .catch(() => {});
        }
      })();
    </script>
  </body>
</html>
