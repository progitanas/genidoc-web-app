<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Demande Couverture Sociale ‚Äî GeniDoc</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      :root {
        --color-secondary-blue: #2563eb;
        --color-primary: #2056ae;
        --color-bg-primary: #ffffff;
        --color-bg-secondary: #f7f9fb;
        --color-accent: #27ae60;
        --font-family-sans: "Space Grotesk", "Segoe UI", Arial, sans-serif;
      }
      body {
        font-family: var(--font-family-sans);
        background: var(--color-bg-secondary);
        margin: 0;
        color: #1f2937;
      }
      .container {
        max-width: 900px;
        margin: 32px auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 24px #2056ae0a;
        padding: 32px 28px;
      }
      h1 {
        color: var(--color-secondary-blue);
        text-align: center;
        margin-bottom: 18px;
      }
      .uml-section {
        margin-bottom: 32px;
      }
      .uml-section h2 {
        color: #2563eb;
        margin-top: 0;
      }
      .uml-class {
        background: #f3f6fa;
        border-left: 4px solid #2563eb;
        padding: 16px 18px;
        margin-bottom: 18px;
        border-radius: 8px;
      }
      .uml-class strong {
        color: #2056ae;
      }
      .uml-methods,
      .uml-attrs {
        margin: 0 0 0 18px;
        padding: 0;
      }
      .uml-methods li,
      .uml-attrs li {
        margin-bottom: 2px;
      }
      .uml-diagram {
        background: #222f3e;
        color: #fff;
        font-family: "Fira Mono", monospace;
        font-size: 0.98em;
        border-radius: 8px;
        padding: 18px;
        overflow-x: auto;
      }
      .doc-note {
        background: #eaf6ff;
        border-left: 4px solid #2563eb;
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 24px;
      }
      @media (max-width: 900px) {
        .container {
          margin: 20px 12px;
          max-width: calc(100% - 24px);
        }
      }
      @media (max-width: 600px) {
        .container {
          padding: 10px 2vw;
        }
      }

      /* GeniDoc header */
      .gd-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }
      .gd-header img {
        width: 56px;
        height: 56px;
        object-fit: contain;
      }
      .gd-header-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--color-secondary-blue);
      }

      /* Button & tab style */
      .tab-btn {
        background: #f3f6fa;
        border: none;
        padding: 8px 14px;
        border-radius: 10px;
        margin-right: 6px;
        cursor: pointer;
      }
      .tab-btn.active,
      .tab-btn:hover {
        background: var(--color-secondary-blue);
        color: #fff;
      }
      .gd-btn {
        background: var(--color-secondary-blue);
        color: #fff;
        border: none;
        padding: 10px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        min-width: 120px;
      }
      .gd-btn.ghost {
        background: transparent;
        border: 1px solid #e2e8f0;
        color: var(--color-secondary-blue);
        min-width: 110px;
      }
      .gd-btn.small {
        padding: 6px 10px;
        font-size: 0.95em;
        min-width: 80px;
        border-radius: 8px;
      }
      .gd-btn.danger {
        background: #ef4444;
        border-color: #ef4444;
      }
      .gd-btn.ghost.danger {
        background: transparent;
        color: #ef4444;
        border-color: #ef4444;
      }
      .gd-btn.success {
        background: var(--color-accent);
      }
      .gd-btn:focus {
        outline: 3px solid rgba(37, 99, 235, 0.18);
        outline-offset: 2px;
      }
      .gd-badge {
        font-size: 0.9rem;
        background: #eaf6ff;
        color: var(--color-secondary-blue);
        padding: 4px 8px;
        border-radius: 8px;
      }

      /* Request list / statuses */
      .request-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f3f6fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .request-item:hover {
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.05);
      }
      .request-left {
        max-width: 70%;
        overflow-wrap: anywhere;
      }
      .request-right {
        text-align: right;
      }
      .action-group {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
        align-items: center;
      }
      .status-badge {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 10px;
        background: #eaf6ff;
        color: var(--color-secondary-blue);
        font-weight: 600;
        margin-right: 8px;
      }
      .controls {
        display: flex;
        gap: 8px;
        align-items: center;
        justify-content: flex-end;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 14px;
        overflow-x: auto;
        padding-bottom: 6px;
      }
      .tabs::-webkit-scrollbar {
        height: 8px;
      }
      .tabs::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="gd-header">
        <img
          src="/static/ong_GeniDoc1preview.png"
          alt="GeniDoc logo"
          title="GeniDoc ‚Äî Plateforme de d√©marches sant√©"
          style="cursor: help"
        />
        <div>
          <div class="gd-header-title">Demande de Couverture Sociale</div>
          <div style="font-size: 0.95rem; color: #64748b">
            AMO / RAMED ‚Äî GeniDoc
          </div>
        </div>
      </div>
      <!-- Toasts -->
      <div
        id="gd-toast"
        style="position: fixed; right: 16px; bottom: 16px; z-index: 9999"
      ></div>
      <!-- Loader -->
      <div
        id="gd-loader"
        style="
          display: none;
          position: fixed;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.6);
          align-items: center;
          justify-content: center;
          z-index: 9998;
        "
      >
        <div
          style="
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
          "
        >
          Chargement...
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="submit">
          Soumettre une demande
        </button>
        <button class="tab-btn" data-tab="track">Suivre mes demandes</button>
        <button class="tab-btn" data-tab="eligibility">
          V√©rifier mon √©ligibilit√©
        </button>
        <button class="tab-btn" data-tab="auth">Authentification</button>
        <button class="tab-btn" data-tab="support">Support digital</button>
      </div>
      <div class="tab-content active" id="tab-submit">
        <form
          id="social-coverage-form"
          class="form-section"
          autocomplete="off"
          enctype="multipart/form-data"
        >
          <div class="gd-float-label">
            <input
              type="text"
              name="fullname"
              id="fullname"
              required
              pattern="[A-Za-z√Ä-√ø' -]{2,}"
            />
            <label for="fullname">Nom complet</label>
          </div>
          <div class="gd-float-label">
            <input
              type="text"
              name="uniqueid"
              id="uniqueid"
              required
              pattern="[A-Za-z0-9]{6,12}"
              maxlength="12"
              aria-describedby="uniqueid-help"
            />
            <label for="uniqueid">Num√©ro d'identifiant unique</label>
            <small id="uniqueid-help" class="gd-help"
              >Ex: CIN (AB123456) ou N¬∞ AMO/RAMED (12345678)</small
            >
          </div>
          <div class="gd-float-label">
            <select
              name="coverageType"
              id="coverageType"
              required
              aria-describedby="coverageType-help"
            >
              <option value="">S√©lectionner‚Ä¶</option>
              <option value="AMO">AMO</option>
              <option value="RAMED">RAMED</option>
            </select>
            <label for="coverageType"
              >Type de couverture
              <span
                tabindex="0"
                class="gd-tooltip"
                aria-label="En savoir plus sur les types de couverture"
                >&#9432;
                <span class="gd-tooltip-text">
                  <strong>AMO</strong>‚ÄØ: Assurance Maladie Obligatoire
                  (salari√©s, √©tudiants, ex-RAMED, etc.)<br />
                  <strong>RAMED</strong>‚ÄØ: R√©gime d'Assistance M√©dicale (pour
                  personnes en situation pr√©caire, en cours de migration vers
                  AMO)
                </span>
              </span>
            </label>
            <small id="coverageType-help" class="gd-help"
              >Choisissez le r√©gime demand√©. Si vous ne savez pas, cliquez sur
              le ‚Äúi‚Äù.</small
            >
          </div>
          <div class="gd-float-label">
            <textarea name="reason" id="reason" rows="3" required></textarea>
            <label for="reason">Motif de la demande</label>
          </div>
          <div class="gd-float-label">
            <input
              type="file"
              name="justificatif"
              id="justificatif"
              accept="image/*,.pdf"
            />
            <label for="justificatif"
              >Pi√®ce jointe (scan CIN ou justificatif)</label
            >
            <small class="gd-help"
              >Format accept√©‚ÄØ: PDF, JPG, PNG. Max 5‚ÄØMo.</small
            >
          </div>
          <button type="submit" class="gd-btn">Envoyer la demande</button>
        </form>
        <div id="form-status" class="status-msg"></div>
        <div id="faq-statuses" class="gd-faq">
          <strong>Explication des statuts‚ÄØ:</strong><br />
          <span class="gd-badge">En attente</span>‚ÄØ: Votre demande est en cours
          d‚Äô√©tude.<br />
          <span class="gd-badge" style="background: #e6ffef; color: #27ae60"
            >Valid√©e</span
          >‚ÄØ: Votre demande a √©t√© accept√©e.<br />
          <span class="gd-badge" style="background: #fde2e2; color: #ef4444"
            >Refus√©e</span
          >‚ÄØ: Votre demande a √©t√© refus√©e (voir support pour motif).
        </div>
        <div style="font-size: 0.95rem; color: #64748b; margin-top: 8px">
          Apr√®s envoi, vous recevrez un email ou notification en cas de
          changement de statut.
        </div>
      </div>
      <div class="tab-content" id="tab-track">
        <div class="form-section">
          <div class="gd-float-label">
            <input
              type="text"
              id="track-uniqueid"
              required
              pattern="[A-Za-z0-9]{6,12}"
              maxlength="12"
              aria-describedby="track-uniqueid-help"
            />
            <label for="track-uniqueid">Num√©ro d'identifiant unique</label>
            <small id="track-uniqueid-help" class="gd-help"
              >Ex: CIN (AB123456) ou N¬∞ AMO/RAMED (12345678)</small
            >
          </div>
          <div
            style="display: flex; gap: 8px; align-items: center"
            class="controls"
          >
            <button
              id="btn-track"
              type="button"
              class="gd-btn"
              aria-label="Afficher mes demandes"
            >
              Afficher mes demandes
            </button>
            <button
              id="btn-track-all"
              type="button"
              class="gd-btn ghost small"
              aria-label="Afficher toutes les demandes"
            >
              Afficher toutes
            </button>
            <button
              id="btn-export-csv"
              type="button"
              class="gd-btn ghost small"
              aria-label="Exporter CSV"
            >
              Exporter CSV
            </button>
          </div>
        </div>
        <div id="track-status" class="status-msg"></div>
        <div id="request-list" class="request-list"></div>
      </div>
      <div class="tab-content" id="tab-eligibility">
        <div class="form-section">
          <label
            >Num√©ro d'identifiant unique (CIN ou N¬∞ AMO/RAMED)
            <input type="text" id="elig-uniqueid" required />
          </label>
          <small style="display: block; color: #64748b; margin-top: 6px"
            >Saisissez votre CIN ou N¬∞ AMO/RAMED pour v√©rifier
            l'√©ligibilit√©.</small
          >
          <button
            id="btn-elig"
            type="button"
            class="gd-btn"
            aria-label="V√©rifier l'√©ligibilit√©"
          >
            V√©rifier l'√©ligibilit√©
          </button>
        </div>
        <div id="elig-status" class="status-msg"></div>
        <div class="gd-faq" style="margin: 32px auto 0; max-width: 900px">
          <strong>FAQ ‚Äî Questions fr√©quentes</strong><br />
          <details>
            <summary>Quels documents fournir‚ÄØ?</summary>
            <div>
              Un scan de votre CIN et, si possible, un justificatif
              d‚Äôaffiliation AMO/RAMED.
            </div>
          </details>
          <details>
            <summary>Comment suivre l‚Äôavancement‚ÄØ?</summary>
            <div>
              Utilisez l‚Äôonglet ‚ÄúSuivre mes demandes‚Äù‚ÄØ; vous pouvez exporter la
              liste pour vos d√©marches.
            </div>
          </details>
          <details>
            <summary>Que signifient les statuts‚ÄØ?</summary>
            <div>Voir l‚Äôencart ‚ÄúExplication des statuts‚Äù ci-dessus.</div>
          </details>
          <details>
            <summary>Mes donn√©es sont-elles prot√©g√©es‚ÄØ?</summary>
            <div>
              Oui, GeniDoc respecte la confidentialit√© et la r√©glementation
              CNDP. Vos donn√©es ne sont jamais partag√©es sans consentement.
            </div>
          </details>
        </div>
        <style>
          .gd-float-label {
            position: relative;
            margin-bottom: 18px;
          }
          .gd-float-label input:not([type="file"]),
          .gd-float-label textarea,
          .gd-float-label select {
            width: 100%;
            padding: 14px 12px 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f7f9fb;
            font-size: 1em;
            transition: border-color 0.2s;
          }
          .gd-float-label input:focus,
          .gd-float-label textarea:focus,
          .gd-float-label select:focus {
            border-color: #2563eb;
            outline: none;
          }
          .gd-float-label label {
            position: absolute;
            left: 14px;
            top: 14px;
            color: #64748b;
            background: transparent;
            font-size: 1em;
            pointer-events: none;
            transition: 0.18s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2;
          }
          .gd-float-label input:not(:placeholder-shown):not([type="file"]),
          .gd-float-label input:focus:not([type="file"]),
          .gd-float-label textarea:not(:placeholder-shown),
          .gd-float-label textarea:focus,
          .gd-float-label select:focus,
          .gd-float-label select:not([value=""]) {
            background: #fff;
          }
          .gd-float-label
            input:not(:placeholder-shown):not([type="file"])
            + label,
          .gd-float-label input:focus:not([type="file"]) + label,
          .gd-float-label textarea:not(:placeholder-shown) + label,
          .gd-float-label textarea:focus + label,
          .gd-float-label select:focus + label,
          .gd-float-label select:not([value=""]) + label {
            top: -10px;
            left: 10px;
            font-size: 0.92em;
            background: #fff;
            padding: 0 4px;
            color: #2563eb;
          }
          .gd-float-label input[type="file"] + label {
            position: static;
            left: 0;
            top: 0;
            font-size: 1em;
            background: none;
            color: #64748b;
            padding: 0;
          }
          .gd-help {
            display: block;
            color: #64748b;
            font-size: 0.93em;
            margin-top: 2px;
            margin-bottom: 2px;
          }
          .gd-tooltip {
            display: inline-block;
            position: relative;
            cursor: pointer;
            color: #2563eb;
            font-size: 1em;
            margin-left: 4px;
          }
          .gd-tooltip-text {
            visibility: hidden;
            width: 320px;
            background: #222f3e;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 10px 14px;
            position: absolute;
            z-index: 10;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.98em;
            box-shadow: 0 4px 18px #2056ae22;
          }
          .gd-tooltip:focus .gd-tooltip-text,
          .gd-tooltip:hover .gd-tooltip-text {
            visibility: visible;
            opacity: 1;
          }
          .gd-faq {
            background: #f3f6fa;
            border-left: 4px solid #2563eb;
            padding: 14px 18px;
            border-radius: 8px;
            margin-top: 18px;
            font-size: 1em;
          }
        </style>
      </div>
      <div class="tab-content" id="tab-auth">
        <div class="form-section">
          <label
            >Identifiant utilisateur
            <input type="text" id="auth-userid" required />
          </label>
          <label
            >Mot de passe
            <input type="password" id="auth-password" required />
          </label>
          <div
            style="display: flex; gap: 10px; align-items: center"
            class="controls"
          >
            <button
              id="btn-login"
              type="button"
              class="gd-btn"
              aria-label="Connexion"
            >
              Connexion
            </button>
            <button
              id="btn-logout"
              type="button"
              class="gd-btn ghost small"
              style="border-color: #f87171; color: #1f2937"
              aria-label="D√©connexion"
            >
              D√©connexion
            </button>
          </div>
        </div>
        <div id="auth-status" class="status-msg"></div>
      </div>
      <div class="tab-content" id="tab-support">
        <div class="support-section">
          <strong>Support digital :</strong><br />
          T√©l√©phone : <a href="tel:+212800123456">+212 800 123 456</a><br />
          Chat en ligne :
          <a href="#" onclick="alert('Chat √† venir !')">Ouvrir le chat</a>
        </div>
        <div class="status-msg">
          Pour toute question, contactez notre support ou utilisez le chat
          int√©gr√©.
        </div>
        <hr />
        <div class="form-section">
          <label
            >Objet
            <input type="text" id="support-subject" placeholder="Sujet" />
          </label>
          <label
            >Message
            <textarea
              id="support-message"
              rows="3"
              placeholder="Expliquez votre demande..."
            ></textarea>
          </label>
          <button
            id="btn-support"
            type="button"
            class="gd-btn small"
            aria-label="Envoyer au support"
          >
            Envoyer au support
          </button>
        </div>
        <div id="support-status" class="status-msg"></div>
      </div>
    </div>
    <div class="doc-note">
      üîé Agents : validez uniquement si tous les documents sont conformes.
      Refuser doit √™tre accompagn√© d'une remarque via le support.
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // basic tab navigation
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.onclick = function () {
            document
              .querySelectorAll(".tab-btn")
              .forEach((b) => b.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((tc) => tc.classList.remove("active"));
            btn.classList.add("active");
            const tab = document.getElementById("tab-" + btn.dataset.tab);
            if (tab) tab.classList.add("active");
          };
        });

        // --- storage helpers ---
        const API_ROOT = "/api";

        async function apiCreateRequest(data) {
          const token = localStorage.getItem("gd_token");
          const res = await fetch(`${API_ROOT}/social-requests`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              ...(token ? { Authorization: `Bearer ${token}` } : {}),
            },
            body: JSON.stringify(data),
          });
          return res.json();
        }

        async function apiGetRequests(uniqueid) {
          const token = localStorage.getItem("gd_token");
          const q = uniqueid ? `?uniqueid=${encodeURIComponent(uniqueid)}` : "";
          const headers = token ? { Authorization: `Bearer ${token}` } : {};
          const res = await fetch(`${API_ROOT}/social-requests${q}`, {
            headers,
          });
          return res.json();
        }

        async function apiGetAllRequests() {
          const token = localStorage.getItem("gd_token");
          const res = await fetch(`${API_ROOT}/social-requests`, {
            headers: { Authorization: `Bearer ${token}` },
          });
          return res.json();
        }

        async function apiUpdateRequestStatus(id, status) {
          const token = localStorage.getItem("gd_token");
          const res = await fetch(`${API_ROOT}/social-requests/${id}/status`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ status }),
          });
          return res.json();
        }

        // --- auth ---
        let authToken = null; // { userID, role }
        const authStatus = document.getElementById("auth-status");

        function setAuth(user) {
          authToken = user;
          if (authToken) {
            // Map backend roles to front-end readable roles
            const readable =
              authToken.role === "ADMIN"
                ? "agent"
                : authToken.role === "PATIENT"
                ? "user"
                : authToken.role;
            authToken.role = readable; // normalize for front-end checks
            authStatus.textContent = `Connect√© (${readable})`;
          } else {
            authStatus.textContent = "D√©connect√©.";
          }
        }

        document
          .getElementById("btn-login")
          .addEventListener("click", async function (e) {
            e.preventDefault();
            const userID = document.getElementById("auth-userid").value.trim();
            const password = document
              .getElementById("auth-password")
              .value.trim();
            authStatus.textContent = "Connexion...";
            try {
              const res = await fetch("/api/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email: userID, password }),
              });
              const j = await res.json();
              if (!j.success) {
                authStatus.textContent = j.message || "Identifiants invalides.";
                return;
              }
              const token = j.token;
              localStorage.setItem("gd_token", token);
              setAuth({
                userID: j.data.email || userID,
                role: j.data.role || "user",
              });
              // Optional: set a genidocId if returned
              if (j.genidocId)
                localStorage.setItem("gd_genidocId", j.genidocId);
            } catch (err) {
              console.error(err);
              authStatus.textContent = "Erreur de connexion.";
            }
          });

        document
          .getElementById("btn-logout")
          .addEventListener("click", async function () {
            localStorage.removeItem("gd_token");
            setAuth(null);
            authStatus.textContent = "D√©connect√©.";
          });

        // --- submission ---
        const form = document.getElementById("social-coverage-form");
        const formStatus = document.getElementById("form-status");
        if (form)
          form.addEventListener("submit", async function (e) {
            e.preventDefault();
            if (!localStorage.getItem("gd_token")) {
              formStatus.textContent = "Veuillez vous authentifier.";
              return;
            }
            const payload = {
              fullname: form.fullname.value,
              uniqueid: form.uniqueid.value,
              coverageType: form.coverageType.value,
              reason: form.reason.value,
            };
            formStatus.textContent = "Envoi en cours...";
            const result = await apiCreateRequest(payload);
            if (result && result.success) {
              formStatus.textContent = "Demande envoy√©e.";
              form.reset();
            } else {
              formStatus.textContent =
                result && result.message
                  ? result.message
                  : "Erreur lors de l‚Äôenvoi.";
            }
          });

        // toasts & loader utilities
        const gdToast = document.getElementById("gd-toast");
        function showToast(msg, type = "info", ttl = 4000) {
          const el = document.createElement("div");
          el.style.background =
            type === "error"
              ? "#fde2e2"
              : type === "success"
              ? "#e6ffef"
              : "#e6f0ff";
          el.style.color = "#022047";
          el.style.padding = "10px 14px";
          el.style.borderRadius = "10px";
          el.style.boxShadow = "0 6px 18px rgba(8,30,78,0.08)";
          el.style.marginTop = "8px";
          el.textContent = msg;
          gdToast.appendChild(el);
          setTimeout(() => {
            el.remove();
          }, ttl);
        }

        function setLoading(on) {
          document.getElementById("gd-loader").style.display = on
            ? "flex"
            : "none";
        }

        // --- render results ---
        // Render requests using server
        let lastAction = null; // for undo

        function addUndoToast(action, onUndo) {
          const toast = document.createElement("div");
          toast.className = "status-msg";
          toast.style.background = "#fff2f2";
          toast.style.padding = "8px";
          toast.style.border = "1px solid #ffdede";
          toast.style.margin = "8px 0";
          toast.innerHTML = `${action} ‚Äî <button class="gd-btn ghost small" style="padding:6px 8px;">Annuler</button>`;
          const btn = toast.querySelector("button");
          btn.addEventListener("click", async function () {
            await onUndo();
            toast.remove();
          });
          document
            .querySelector(".container")
            .insertBefore(
              toast,
              document.querySelector(".container").firstChild
            );
          // auto remove after 12s
          setTimeout(() => {
            if (toast.parentNode) toast.remove();
          }, 12000);
        }

        async function renderRequests(uniqueid) {
          const listEl = document.getElementById("request-list");
          listEl.innerHTML = "";
          const rj = await apiGetRequests(uniqueid);
          const all = rj && rj.success ? rj.data : [];
          if (!all.length) {
            listEl.innerHTML =
              '<div class="request-item">Aucune demande trouv√©e.</div>';
            return;
          }
          all.reverse().forEach((r) => {
            const statusClass =
              r.status === "attente"
                ? "status-attente"
                : r.status === "validee"
                ? "status-validee"
                : "status-refusee";
            const div = document.createElement("div");
            div.className = "request-item";
            const left = document.createElement("div");
            left.className = "request-left";
            left.innerHTML = `<strong>${r.id}</strong> ‚Äî ${
              r.fullname
            }<br>Type: ${
              r.coverageType
            }<br><small style='color:#64748b'>${new Date(
              r.createdAt
            ).toLocaleString()}</small>`;
            const right = document.createElement("div");
            right.className = "request-right";
            const badge = document.createElement("span");
            badge.className = `status-badge request-status ${statusClass}`;
            badge.textContent =
              r.status === "attente"
                ? "En attente"
                : r.status === "validee"
                ? "Valid√©e"
                : "Refus√©e";
            right.appendChild(badge);

            // Admin actions - grouped and compact
            const actions = document.createElement("div");
            actions.className = "action-group";
            if (
              localStorage.getItem("gd_token") &&
              authToken &&
              authToken.role === "agent"
            ) {
              if (r.status === "attente") {
                const btnValidate = document.createElement("button");
                btnValidate.className = "gd-btn small success";
                btnValidate.setAttribute("aria-label", "Valider la demande");
                btnValidate.title = "Valider la demande - action irr√©versible";
                btnValidate.textContent = "Valider";
                btnValidate.addEventListener("click", async function () {
                  setLoading(true);
                  const j = await apiUpdateRequestStatus(r.id, "validee");
                  setLoading(false);
                  if (j && j.success) {
                    showToast("Demande valid√©e", "success");
                    renderRequests(uniqueid);
                  } else showToast(j && j.message ? j.message : "Erreur lors de la validation", "error");
                });
                const btnRefuse = document.createElement("button");
                btnRefuse.className = "gd-btn small ghost danger";
                btnRefuse.setAttribute("aria-label", "Refuser la demande");
                btnRefuse.title =
                  "Refuser la demande - vous pouvez annuler pendant 12s";
                btnRefuse.textContent = "Refuser";
                btnRefuse.addEventListener("click", async function () {
                  if (!confirm("Confirmer le refus de cette demande ?")) return;
                  setLoading(true);
                  const j = await apiUpdateRequestStatus(r.id, "refusee");
                  setLoading(false);
                  if (j && j.success) {
                    // add undo
                    addUndoToast("Demande refus√©e", async () => {
                      await apiUpdateRequestStatus(r.id, "attente");
                      renderRequests(uniqueid);
                    });
                    renderRequests(uniqueid);
                  }
                });
                actions.appendChild(btnValidate);
                actions.appendChild(btnRefuse);
              }
            }
            right.appendChild(actions);

            div.appendChild(left);
            div.appendChild(right);
            listEl.appendChild(div);
          });
        }

        function saveAndRefresh(item) {
          const trackId = document.getElementById("track-uniqueid").value;
          renderRequests(trackId);
        }

        // Track
        document
          .getElementById("btn-track")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (!authToken) {
              showToast("Veuillez vous authentifier.", "error");
              return;
            }
            const uniqueid = document.getElementById("track-uniqueid").value;
            document.getElementById("track-status").textContent =
              "Recherche...";
            setLoading(true);
            setTimeout(async () => {
              document.getElementById("track-status").textContent = "";
              setLoading(false);
              await renderRequests(uniqueid);
            }, 500);
          });

        // Track all for agents
        document
          .getElementById("btn-track-all")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (!authToken || authToken.role !== "agent") {
              document.getElementById("track-status").textContent =
                "Action r√©serv√©e aux agents.";
              return;
            }
            renderRequests(null); // show all
          });

        // Eligibility
        document
          .getElementById("btn-elig")
          .addEventListener("click", function (e) {
            e.preventDefault();
            if (!authToken) {
              document.getElementById("elig-status").textContent =
                "Veuillez vous authentifier.";
              return;
            }
            const uniqueid = document.getElementById("elig-uniqueid").value;
            document.getElementById("elig-status").textContent =
              "V√©rification...";
            setTimeout(() => {
              // simulate simple eligibility
              if (/^\d{8,}$/.test(uniqueid)) {
                document.getElementById("elig-status").textContent =
                  "√âligible (simulation)";
              } else {
                document.getElementById("elig-status").textContent =
                  "Non √©ligible ou identifiant inconnu.";
              }
            }, 700);
          });

        // Support submission
        const btnSupport = document.getElementById("btn-support");
        if (btnSupport)
          btnSupport.addEventListener("click", async function (e) {
            e.preventDefault();
            if (!authToken) {
              showToast("Veuillez vous authentifier.", "error");
              return;
            }
            const subject = document
              .getElementById("support-subject")
              .value.trim();
            const message = document
              .getElementById("support-message")
              .value.trim();
            if (!subject || !message) {
              showToast("Veuillez remplir le sujet et le message.", "error");
              return;
            }
            try {
              setLoading(true);
              const token = localStorage.getItem("gd_token");
              const res = await fetch("/api/support", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ subject, message }),
              });
              const j = await res.json();
              setLoading(false);
              if (j && j.success) {
                showToast("Message envoy√© au support.");
                document.getElementById("support-subject").value = "";
                document.getElementById("support-message").value = "";
              } else {
                showToast(j.message || "Erreur lors de l‚Äôenvoi", "error");
              }
            } catch (err) {
              setLoading(false);
              console.error(err);
              showToast("Erreur r√©seau - r√©essayez", "error");
            }
          });

        // No local sample data anymore; server seeded or empty
      });
    </script>
  </body>
</html>
