<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GeniDoc Map Intelligence</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f7fa;
        margin: 0;
      }
      .container {
        max-width: 720px;
        margin: 32px auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 16px #2056ae22;
        padding: 28px;
      }
      h2 {
        color: #2056ae;
        text-align: center;
        margin-top: 0;
      }
      label {
        display: block;
        margin-top: 12px;
        font-weight: 600;
        color: #213a66;
      }
      input[type="text"],
      input[type="url"],
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1.5px solid #d6d6f7;
        margin-top: 6px;
        font-size: 0.98em;
        background: #fafcff;
      }
      input[type="file"] {
        margin-top: 6px;
      }
      .two-col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      button {
        background: #2056ae;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 0.98em;
        font-weight: 700;
        cursor: pointer;
        margin-top: 14px;
      }
      .secondary {
        background: #fff;
        color: #2056ae;
        border: 1.5px solid #2056ae;
      }
      .result {
        background: #f0f4ff;
        border-radius: 10px;
        padding: 14px;
        margin-top: 18px;
        font-size: 0.95em;
        word-break: break-all;
      }
      .preview {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }
      .thumb {
        width: 96px;
        height: 96px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #d6d6f7;
        background: #fff;
      }
      .field {
        margin-top: 8px;
      }
      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      pre {
        white-space: pre-wrap;
        overflow-x: auto;
        margin: 0;
      }
      .hint {
        font-size: 0.9em;
        color: #556;
        margin-top: 6px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>Ajouter un établissement à GeniDoc Map — Assistant</h2>

      <form id="map-form" enctype="multipart/form-data" novalidate>
        <div class="two-col">
          <div>
            <label for="photo">Photo (optionnel)</label>
            <input type="file" id="photo" accept="image/*" />
          </div>
          <div>
            <label for="source">Texte libre / Description</label>
            <input
              id="source"
              type="text"
              placeholder="Collez une description : 'Cabinet du Dr Anas Senhaji, Médecin généraliste, 12 Rue Socrate, Maarif, Casablanca, 0522334455'"
            />
            <div class="hint">
              Vous pouvez coller une fiche, une publication ou taper quelques
              lignes.
            </div>
          </div>
        </div>

        <label for="description">Texte complet (optionnel)</label>
        <textarea
          id="description"
          rows="4"
          placeholder="Description complète, horaires, notes..."
        ></textarea>

        <div class="actions">
          <button type="button" id="analyze">Analyser & structurer</button>
          <button type="submit" class="secondary">
            Analyser et envoyer au serveur
          </button>
          <button type="button" id="clear" class="secondary">Vider</button>
        </div>
      </form>

      <div id="result" class="result" style="display: none">
        <div class="preview" style="margin-bottom: 10px">
          <img
            id="thumb"
            class="thumb"
            alt="Aperçu"
            src=""
            style="display: none"
          />
          <div style="flex: 1">
            <div class="field">
              <label>Nom / Établissement</label>
              <input id="field-name" type="text" />
            </div>
            <div class="field">
              <label>Spécialité</label>
              <input id="field-specialty" type="text" />
            </div>
            <div class="field">
              <label>Adresse (libre)</label>
              <input id="field-address" type="text" />
            </div>
          </div>
        </div>

        <div class="two-col">
          <div>
            <label>Téléphone(s)</label>
            <input
              id="field-phone"
              type="text"
              placeholder="Ex: 06 12 34 56 78; +212521234567"
            />
          </div>
          <div>
            <label>Site ou email</label>
            <input
              id="field-contact"
              type="text"
              placeholder="email@example.com ou https://..."
            />
          </div>
        </div>

        <div class="field">
          <label>Notes / Horaires</label>
          <textarea id="field-notes" rows="3"></textarea>
        </div>

        <div class="actions" style="margin-top: 12px">
          <button id="copy-json">Copier JSON</button>
          <button id="download-json" class="secondary">Télécharger JSON</button>
          <button id="open-maps" class="secondary">
            Ouvrir dans Google Maps
          </button>
          <button id="send-server">Envoyer au serveur</button>
        </div>

        <h4 style="margin-top: 14px; color: #25407a">
          Aperçu structuré (JSON-LD)
        </h4>
        <div style="background: #ffffff; border-radius: 8px; padding: 10px">
          <pre id="jsonld" style="margin: 0"></pre>
        </div>
      </div>
    </div>

    <script>
      // Heuristics-based parser (fr)
      function extractPhones(text) {
        const phoneRegex =
          /(\+?\d{1,3}[\s.-]?)?(\(?\d{2,4}\)?[\s.-]?)?[\d\s.-]{6,}/g;
        const matches = (text || "").match(phoneRegex) || [];
        // clean and unique
        return [...new Set(matches.map((s) => s.trim()))].slice(0, 5);
      }

      function extractEmails(text) {
        const re = /[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}/g;
        return (text || "").match(re) || [];
      }

      function extractUrls(text) {
        const re = /(https?:\/\/[^\s]+)/g;
        return (text || "").match(re) || [];
      }

      function guessNameAndSpecialty(text) {
        if (!text) return { name: "", specialty: "" };
        // split by commas / - / newline
        const parts = text
          .split(/[\n,–\-]+/)
          .map((s) => s.trim())
          .filter(Boolean);
        // first part often contains name
        let name = parts[0] || "";
        let specialty = "";
        // try to detect specialty words
        const keywords = [
          "médecin",
          "dentiste",
          "pharmaci",
          "infirm",
          "clinique",
          "laboratoire",
          "chirurg",
          "ophtalm",
          "pédiatr",
          "gynécolog",
          "cardio",
          "psy",
        ];
        for (let p of parts.slice(0, 3)) {
          for (let k of keywords) {
            if (p.toLowerCase().includes(k)) {
              specialty = p;
              if (p !== name) name = parts[0];
            }
          }
        }
        return { name, specialty };
      }

      function extractAddress(text) {
        if (!text) return "";
        // naive: look for numbers + street words or city keywords
        const streetRegex =
          /(\d{1,4}\s?[A-Za-zÀ-ÖØ-öø-ÿ'’.-]+\s+(Rue|Av|Avenue|Boulevard|Bd|Place|Impasse|Ruelle|Lot|Chemin|Cours|Square)\b[^\n,]*)/i;
        const match = text.match(streetRegex);
        if (match) return match[0].trim();
        // fallback: look for city names (maarif, casablanca, rabat, marrakech)
        const cityRegex =
          /\b(Maarif|Casablanca|Rabat|Marrakech|Fès|Fez|Tanger|Tétouan)\b/i;
        const cityMatch = text.match(cityRegex);
        if (cityMatch)
          return (text.split(cityMatch[0])[0] + cityMatch[0]).trim();
        return "";
      }

      function buildJsonLd(obj) {
        const schema = {
          "@context": "https://schema.org",
          "@type": "MedicalOrganization",
          name: obj.name || undefined,
          description: obj.notes || undefined,
          address: obj.address || undefined,
          telephone: obj.phone && obj.phone.length ? obj.phone : undefined,
          url: obj.contact || undefined,
        };
        // remove undefined keys
        Object.keys(schema).forEach(
          (k) => schema[k] === undefined && delete schema[k]
        );
        return JSON.stringify(schema, null, 2);
      }

      const photoInput = document.getElementById("photo");
      const sourceInput = document.getElementById("source");
      const descriptionInput = document.getElementById("description");
      const analyzeBtn = document.getElementById("analyze");
      const resultEl = document.getElementById("result");
      const thumb = document.getElementById("thumb");

      const fieldName = document.getElementById("field-name");
      const fieldSpecialty = document.getElementById("field-specialty");
      const fieldAddress = document.getElementById("field-address");
      const fieldPhone = document.getElementById("field-phone");
      const fieldContact = document.getElementById("field-contact");
      const fieldNotes = document.getElementById("field-notes");
      const jsonldEl = document.getElementById("jsonld");

      function resetForm() {
        sourceInput.value = "";
        descriptionInput.value = "";
        photoInput.value = "";
        thumb.src = "";
        thumb.style.display = "none";
        resultEl.style.display = "none";
        fieldName.value =
          fieldSpecialty.value =
          fieldAddress.value =
          fieldPhone.value =
          fieldContact.value =
          fieldNotes.value =
            "";
        jsonldEl.textContent = "";
      }

      document.getElementById("clear").onclick = resetForm;

      photoInput.onchange = async function () {
        const f = photoInput.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          thumb.src = reader.result;
          thumb.style.display = "block";
        };
        reader.readAsDataURL(f);
      };

      function assembleStructured(fromUserEdit = false) {
        const name = fieldName.value || "";
        const specialty = fieldSpecialty.value || "";
        const address = fieldAddress.value || "";
        const phones = (fieldPhone.value || "")
          .split(/[;,]+/)
          .map((s) => s.trim())
          .filter(Boolean);
        const contact = fieldContact.value || "";
        const notes = fieldNotes.value || descriptionInput.value || "";
        const obj = { name, specialty, address, phone: phones, contact, notes };
        jsonldEl.textContent = buildJsonLd(obj);
        return obj;
      }

      analyzeBtn.onclick = async function () {
        const text = [sourceInput.value, descriptionInput.value]
          .filter(Boolean)
          .join("\n");
        const phones = extractPhones(text);
        const emails = extractEmails(text);
        const urls = extractUrls(text);
        const address = extractAddress(text);
        const guess = guessNameAndSpecialty(
          sourceInput.value || descriptionInput.value
        );

        // populate fields
        fieldName.value = guess.name || "";
        fieldSpecialty.value = guess.specialty || "";
        fieldAddress.value = address || "";
        fieldPhone.value = phones.join("; ");
        fieldContact.value = emails.concat(urls).join("; ");
        fieldNotes.value = descriptionInput.value || "";

        // show thumbnail if present
        if (photoInput.files[0]) {
          const reader = new FileReader();
          reader.onload = () => {
            thumb.src = reader.result;
            thumb.style.display = "block";
          };
          reader.readAsDataURL(photoInput.files[0]);
        }

        resultEl.style.display = "block";
        assembleStructured();
      };

      // Copy, download, open maps
      document.getElementById("copy-json").onclick = function () {
        const obj = assembleStructured();
        navigator.clipboard.writeText(JSON.stringify(obj, null, 2)).then(
          () => {
            alert("JSON copié dans le presse-papiers.");
          },
          () => alert("Impossible de copier.")
        );
      };

      document.getElementById("download-json").onclick = function () {
        const obj = assembleStructured();
        const blob = new Blob([JSON.stringify(obj, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = (obj.name || "genidoc-establishment") + ".json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      document.getElementById("open-maps").onclick = function () {
        const q = encodeURIComponent(
          fieldAddress.value || fieldName.value || sourceInput.value
        );
        const url = "https://www.google.com/maps/search/?api=1&query=" + q;
        window.open(url, "_blank");
      };

      // Send to server (same endpoint your project uses)
      document.getElementById("map-form").onsubmit = async function (e) {
        e.preventDefault();
        // ensure result is visible & fields synchronized
        if (resultEl.style.display === "none") {
          analyzeBtn.click();
        }
        const obj = assembleStructured();

        const form = new FormData();
        if (photoInput.files[0]) form.append("photo", photoInput.files[0]);
        form.append("description", JSON.stringify(obj));

        try {
          const res = await fetch("/api/genidoc-map", {
            method: "POST",
            body: form,
          });
          const data = await res.json();
          alert("Réponse serveur: " + (data.message || JSON.stringify(data)));
        } catch (err) {
          alert("Erreur envoi: " + err.message);
        }
      };

      document.getElementById("send-server").onclick = function () {
        // trigger submit flow
        document.getElementById("map-form").requestSubmit();
      };
    </script>
  </body>
</html>
