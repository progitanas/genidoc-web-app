<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Carte Vitale Numérique — GeniDoc</title>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.9.7/dist/face-api.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; margin: 0; }
    .container { max-width: 420px; margin: 48px auto; background: #fff; border-radius: 18px; box-shadow: 0 8px 32px #4d3aff22; padding: 36px 28px; text-align:center; }
    h1 { color: #2056AE; font-size: 1.5em; margin-bottom: 18px; }
    .desc { color: #444; margin-bottom: 24px; }
    #qrcode { margin: 18px auto; }
    .btn { background: #2056AE; color: #fff; border: none; border-radius: 8px; padding: 10px 22px; font-size: 1em; font-weight: 700; cursor: pointer; margin-top: 18px; }
    .btn:hover { background: #174080; }
    .iot-status { margin: 18px 0; color: #27ae60; font-weight: 600; }
    .camera-preview { margin: 18px auto; display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Carte Vitale Numérique</h1>
    <div class="desc">Votre carte GeniDoc avec QR code, NFC/IoT, et détection par caméra.</div>
    <div id="qrcode"></div>
    <div style="margin:10px 0 18px 0;">
      <button class="btn" id="export-fhir">Exporter FHIR/HL7</button>
      <a id="download-fhir" style="display:none;"></a>
    </div>
    <div class="iot-status" id="iot-status">IoT/NFC : <span id="nfc-status">Non détecté</span></div>
    <button class="btn" id="camera-btn">Détecter par caméra</button>
    <video id="camera-preview" width="240" height="180" autoplay style="display:none;"></video>
    <div id="face-status" style="color:#2056AE;margin:10px 0 0 0;"></div>
    <div style="margin-top:24px;">
      <button class="btn" onclick="window.location.href='index-dashbord.html'">Retour espace patient</button>
    </div>
    <div style="margin-top:18px;font-size:0.92em;color:#888;">
      <b>Sécurité :</b> QR/NFC = token sécurisé, chiffrement AES, authentification forte (PIN, biométrie).<br>
      <b>Interopérabilité :</b> Export FHIR/HL7 JSON, compatible DMP.
    </div>
  </div>
  <script>
    // --- Secure Token (for QR/NFC) ---
    function generateToken(id) {
      // In production: use JWT or backend-generated token
      const payload = { id, ts: Date.now(), rnd: Math.random().toString(36).slice(2,10) };
      return btoa(JSON.stringify(payload));
    }
    // --- QR Code ---
    const genidocId = localStorage.getItem('genidocId') || 'GD-000000';
    const token = generateToken(genidocId);
    QRCode.toCanvas(document.createElement('canvas'), token, function (err, canvas) {
      if (!err) {
        canvas.style.margin = '0 auto';
        document.getElementById('qrcode').appendChild(canvas);
      }
    });
    // --- FHIR/HL7 Export ---
    document.getElementById('export-fhir').onclick = function() {
      const fhir = {
        resourceType: 'Patient',
        id: genidocId,
        name: [{ family: 'Nom', given: ['Prénom'] }],
        birthDate: '1990-01-01',
        identifier: [{ system: 'https://genidoc.fr', value: genidocId }]
      };
      const blob = new Blob([JSON.stringify(fhir, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.getElementById('download-fhir');
      a.href = url;
      a.download = `fhir-patient-${genidocId}.json`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    };
    // --- NFC/IoT (Web NFC API, demo) ---
    if ('NDEFReader' in window) {
      const nfcStatus = document.getElementById('nfc-status');
      const reader = new NDEFReader();
      reader.scan().then(() => {
        nfcStatus.textContent = 'Carte détectée';
        nfcStatus.style.color = '#27ae60';
      }).catch(() => {
        nfcStatus.textContent = 'Non détecté';
        nfcStatus.style.color = '#e74c3c';
      });
      // Write token to NFC (demo)
      /* Uncomment for write demo
      reader.write({ records: [{ recordType: 'text', data: token }] });
      */
    }
    // --- Caméra (WebRTC + Face Detection with TensorFlow.js) ---
    document.getElementById('camera-btn').onclick = async function() {
      const video = document.getElementById('camera-preview');
      const faceStatus = document.getElementById('face-status');
      video.style.display = 'block';
      faceStatus.textContent = 'Chargement du modèle de détection...';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
        await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.9.7/model/');
        faceStatus.textContent = 'Modèle chargé. Détection en cours...';
        let detected = false;
        const detect = async () => {
          if (!video.srcObject) return;
          const result = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions());
          if (result) {
            detected = true;
            faceStatus.textContent = 'Visage détecté. Accès validé.';
            setTimeout(()=>{
              stream.getTracks().forEach(t=>t.stop());
              video.style.display = 'none';
              faceStatus.textContent = '';
            }, 2000);
          } else if (!detected) {
            setTimeout(detect, 400);
          }
        };
        detect();
      } catch(e) {
        faceStatus.textContent = 'Impossible d\'accéder à la caméra.';
      }
    };
  </script>
</body>
</html>
